# **Scenario 2: Self-irrigation**

## **Description**

The main goal for this scenario is to learn how to implement an automated irrigation system.
The scenario it self is divided into three different parts:
- [Preparation.](#1-Preparation)

- [Set up an alarm system.](#2-set-up-an-alarm-system)

- [Automated irrigation.](#3-automated-irrigation)

- [Azure Maps for weather prediction.](#4-azure-maps-for-weather-prediction)

## **Breakdown of the scenario**
### **1. Preparation**

#### **Setting Hardware:**

Mainly two sensors are used in this scenario. They are the Grove temperature and humidity sensor (GHT11) and the Grove moisture sensor.

Let's set up the **GHT11 sensor** first.

- Plug the Grove Base Hat into Raspberry Pi.

- Connect the temperature and humidity sensor to Port 12 of the Base Hat.

![Image](https://github.com/albaye/FarmBeats_project/blob/master/images/temphumid.jpg)

Similar instrustrustions are applied to the **moisture sensor** as well.

- Connect the Grove - Moisture Sensor to the A0 port of the Base Hat.

- After plugging in all the sensors above, connect the Raspberry Pi to PC through USB cable.

![Image](https://github.com/albaye/FarmBeats_project/blob/master/images/moisture.jpg)

#### **Setting Software:**

- Install the **Grove** module.

```
curl -sL https://github.com/Seeed-Studio/grove.py/raw/master/install.sh | sudo bash -s -
```

Still, we start up with the **GHT11**.

- Download the source file by cloning the grove.py library.

```
cd ~
git clone https://github.com/Seeed-Studio/Seeed_Python_DHT.git
```

- Excute below commands to run the code.

```
cd Seeed_Python_DHT
sudo python setup.py install
cd ~/Seeed_Python_DHT/examples
python dht_simpleread.py 
```

- Now try to detect the atmosphere temperature and moisture with the following **dht_simpleread.py** code.

```python
import time
import seeed_dht
def main():
 
    # for DHT11/DHT22
    sensor = seeed_dht.DHT("11", 12)
    # for DHT10
    # sensor = seeed_dht.DHT("10")
 
    while True:
        humi, temp = sensor.read()
        if not humi is None:
            print('DHT{0}, humidity {1:.1f}%, temperature {2:.1f}*'.format(sensor.dht_type, humi, temp))
        else:
            print('DHT{0}, humidity & temperature: {1}'.format(sensor.dht_type, temp))
        time.sleep(1)
 
 
if __name__ == '__main__':
    main()
```
Then we switch to the **moisture sensor**.

- Excute below commands.

```
cd grove.py/grove
python grove_moisture_sensor.py 0
```

- Following is the **grove_moisture_sensor.py** code.

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# The MIT License (MIT)
#
# Grove Base Hat for the Raspberry Pi, used to connect grove sensors.
# Copyright (C) 2018  Seeed Technology Co.,Ltd.
'''
This is the code for
    - Grove - Moisture Sensor <https://www.seeedstudio.com/Grove-Moisture-Sensor-p-955.html>`_
 
Examples:
 
    .. code-block:: python
 
        import time
        from grove.grove_moisture_sensor import GroveMoistureSensor
 
        # connect to alalog pin 2(slot A2)
        PIN = 2
 
        sensor = GroveMoistureSensor(PIN)
 
        print('Detecting moisture...')
        while True:
            m = sensor.moisture
            if 0 <= m and m < 300:
                result = 'Dry'
            elif 300 <= m and m < 600:
                result = 'Moist'
            else:
                result = 'Wet'
            print('Moisture value: {0}, {1}'.format(m, result))
            time.sleep(1)
'''
import math
import sys
import time
from grove.adc import ADC
 
__all__ = ["GroveMoistureSensor"]
 
class GroveMoistureSensor:
    '''
    Grove Moisture Sensor class
 
    Args:
        pin(int): number of analog pin/channel the sensor connected.
    '''
    def __init__(self, channel):
        self.channel = channel
        self.adc = ADC()
 
    @property
    def moisture(self):
        '''
        Get the moisture strength value/voltage
 
        Returns:
            (int): voltage, in mV
        '''
        value = self.adc.read_voltage(self.channel)
        return value
 
Grove = GroveMoistureSensor
 
 
def main():
    from grove.helper import SlotHelper
    sh = SlotHelper(SlotHelper.ADC)
    pin = sh.argv2pin()
 
    sensor = GroveMoistureSensor(pin)
 
    print('Detecting moisture...')
    while True:
        m = sensor.moisture
        if 0 <= m and m < 300:
            result = 'Dry'
        elif 300 <= m and m < 600:
            result = 'Moist'
        else:
            result = 'Wet'
        print('Moisture value: {0}, {1}'.format(m, result))
        time.sleep(1)
 
if __name__ == '__main__':
    main()
```


### **2. Set up an alarm system**

#### **Objective**
Set up a system to alert the user when the plant needs to be watered. 

#### **Learning outcomes**
- Investigate creating rules using Azure IoT Central
  - Send email or push notification when the soil moisture is below a certain threshold.

  - Optional: check if temperature/pressure/light intensity is outside the optimal range.

  - Learn to use Azure Events Hub, Azure Stream Analytics and Azure Functions to process data.
  - Determine the date and time that the plant was last watered.

#### **Key areas to teach**
IoT Azure Services, Data, Microcontroller Programming, AI.


_Optionally a LED indicator can be integrated to indicate if the plant needs watering._

#### **Python example script for sending alarm email with a gmail account**
```python
import RPi.GPIO as GPIO
import time
import smtplib
from email.mime.text import MIMEText
# import libraries for SMTP and email related functions

def main():

    sensor1 = seeed_dht.DHT("11", 12)
    # sensor1: DHT11

    from grove.helper import SlotHelper
    sh = SlotHelper(SlotHelper.ADC)
    pin = sh.argv2pin()
    sensor2 = GroveMoistureSensor(pin)
    # sensor2: moisture sensor

    alarm_state = False
    # create a default alarm state

    from_email_addr = 'sender_email@gmail.com'
    from_email_password = 'sender_email_password'
    to_email_addr = 'receiver_email@gmail.com'
    # set up the email credentials

    body = 'Farmbeats Alert: Your plants are thirsty!!'
    msg = MIMEText(body)
    # set email message

    msg['From'] = from_email_addr
    msg['To'] = to_email_addr
    # set sender and recipient

    msg['Subject'] = 'FARMBEATS ALERT!!!'

    while True:
        humi, temp = sensor1.read()
        m = sensor2.moisture
        if 0 <= m and m < 300 and temp > 25:
            alarm_state = True
            print('Alarm ON')

        if alarm_state == True:
            server = smtplib.SMTP('smtp.gmail.com', 587)
            # connect to server and get ready to send email
            # edit above lines with your email provider's SMTP server details
            server.starttls()
            # comment out this line if provider does not use TLS
            server.login(from_email_addr, from_email_password)
            server.sendmail(from_email_addr, to_email_addr, msg.as_string())
            server.quit()
            print('Email sent')
            alarm_state = False
```

### **3. Automated irrigation**

#### Objective
To set up a simple automated irrigation system.

_**Additional equipment:** Relay module, water pump._

#### Learning Outcomes
- Practical application of previous knowledge that links to digital farming.

  - Option 1: 
    Setup the water pump with existing device
  
  - Option 2: Register a separate device to control the water pump.

### 4. Azure Maps for weather prediction

#### Objective
Use Azure Maps to determine whether irrgation is needed depending on weather conditions. 

#### Learning Outcomes
- Learn to interface with other Azure Services.

- Become confortable with more complex data processing.

### **Azure Services Integration**
![AzureServiceS1](../images/AzureServices_Scenario2.png)

<hr>

*Go to next scenario: [Predict the weather](./3.-Predict_the_weather.md)*
